<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>端对端</title>
  <style>
    * {
      margin: 0;
      padding: 0;
    }

    .page-container {
      width: 900px;
      height: 600px;
      margin: 50px auto 0;
      display: flex;
      border: 1px solid #ccc;
      position: relative;
    }

    .mask {
      position: absolute;
      top: 0;
      bottom: 0;
      left: 0;
      right: 0;
      background: #ccc;
    }

    .mask-content {
      width: 300px;
      margin: 100px auto;
      text-align: center;
      ;
    }

    .message-box {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .message-list {
      height: 500px;
      padding: 10px;
      overflow-y: auto;
    }

    .message-list .left {
      text-align: left;
      color: red;
      line-height: 30px;
    }

    .message-list .right {
      text-align: right;
      color: blue;
      line-height: 30px;
    }

    .send-box {
      height: 100px;
      border-top: 1px solid #ccc;
      display: flex;
    }

    .send-box textarea {
      flex: 1;
      padding: 10px;
    }

    .send-box button {
      width: 80px;
    }

    .user-box {
      width: 200px;
      height: 100%;
      border: 1px solid #ccc;
      display: flex;
      flex-direction: column;
    }

    .local-video,
    .remote-video {
      display: block;
      height: 200px;
      display: none;
    }

    .user-box .title {
      height: 30px;
      text-align: center;
    }

    .user-box .user-list {
      flex: 1;
      padding: 0 10px;
      overflow-y: auto;
    }

    .user-list .user-li {
      line-height: 30px;
      padding: 0 10px;
      height: 30px;
      background: #f5f5f5;
      margin-bottom: 4px;
      position: relative;
    }

    .user-li .cannot-call {
      display: none;
    }

    .user-li .can-call {
      position: absolute;
      right: 0;
      height: 100%;
      line-height: 30px;
      padding: 0 4px;
    }
  </style>
</head>

<body>
  <div class="page-container">
    <div class="message-box">
      <ul class="message-list"></ul>
      <div class="send-box">
        <textarea class="send-content"></textarea>
        <button class="sendbtn">发送</button>
      </div>
    </div>
    <div class="user-box">
      <video id="local-video" autoplay class="local-video"></video>
      <video id="remote-video" autoplay class="remote-video"></video>
      <p class="title">在线用户</p>
      <ul class="user-list"></ul>
    </div>
    <div class="mask">
      <div class="mask-content">
        <input class="myname" type="text" placeholder="输入用户名加入房间">
        <button class="add-room">加入</button>
      </div>
    </div>
    <div class="video-box">

    </div>
  </div>


  <script src="/js/jquery.js"></script>
  <script src="/js/socket.io.js"></script>
  <script>
    function connentSocket() {
      return new Promise((resolve, reject) => {
        let socket = io("http://127.0.0.1:3003/", {
          path: "/websocket"
        })
        socket.on("connect", () => {
          console.log("连接成功！")
          resolve(socket)
        })
        socket.on("connect_error", e => {
          console.log("连接失败！")
          throw e
          reject()
        })
      })
    }
    class Chat {
      constructor() {
        this.host = 'http://127.0.0.1:3003'
        this.socketPath = "/websocket"
        this.socket = null
      }
      async init() {
        this.socket = await this.connentSocket()
        return this
      }
      async connentSocket() {
        if(this.socket) return this.socket
        return new Promise((resolve, reject) => {
          let socket = io(this.host, { path: this.socketPath })
          socket.on("connect", () => {
            console.log("连接成功！")
            resolve(socket)
          })
          socket.on("connect_error", e => {
            console.log("连接失败！")
            throw e
            reject()
          })
        })
      }
      addEvent(name, cb) {
        if (!this.socket) return
        this.socket.on(name, (data) => {
          cb(data)
        })
      }
      sendMessage (name, data) {
        if (!this.socket) return
        this.socket.emit(name, data)
      }

    }
  </script>
  <script>
    $(function () {
      let socket = null
      let chat = new Chat()

      function initEvent() {
        if (!socket) return console.log('socket没有连接');
        // 用户列表更新
        socket.on("updateUserList", list => {
          updateUserList(list)
        })
        // 消息列表更新
        socket.on('updateMessageList', msg => {
          updateMessageList(msg)
        })

      }
      function sendMessage(name, data) {
        if (!socket) return console.log('socket没有连接');
        socket.emit(name, data)
      }
      // 更新用户列表视图
      function updateUserList(list) {
        $(".user-list").html(list.reduce((temp, li) => {
          temp += `<li class="user-li">${li.name} <button data-calling=${li.calling} data-id=${li.id} class=${li.id === socket.id || li.calling ? 'cannot-call' : 'can-call'}> 通话</button></li>`
          return temp
        }, ''))
      }
      // 更新消息li表视图
      function updateMessageList(msg) {
        $('.message-list').append(`<li class=${msg.userId === socket.id ? 'left' : 'right'}>${msg.user}: ${msg.content}</li>`)
      }

      // 加入房间
      $('.add-room').on('click', async () => {
        let name = $('.myname').val()
        if (!name) return
       
        
        $('.mask').fadeOut()
        await chat.init()
        chat.addEvent('updateUserList', updateUserList)
        chat.sendMessage('addUser', {name})

      })
      // 发送消息
      $('.sendbtn').on('click', () => {
        let sendContent = $('.send-content').val()
        if (!sendContent) return
        $('.send-content').val('')
        sendMessage('sendMessage', { content: sendContent })
      })


      // 视屏
      $('.user-list').on('click', '.can-call', async function () {

        console.log($(this).data());
        let localMedia = await getLocalMedia()

        $('.local-video').fadeIn()
        document.getElementById('local-video').srcObject = localMedia

      })

      async function getLocalMedia() {
        return await navigator.mediaDevices
          .getUserMedia({ video: { facingMode: "user" }, audio: true })
          .catch(e => {
            console.log(e)
          })
      }


    })
  </script>
</body>

</html>